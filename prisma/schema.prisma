// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  password      String
  name          String?
  phone         String?
  avatar        String?
  isVerified    Boolean   @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  role          Role      @default(USER)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  ads           Ad[]
  favorites     Favorite[]
  messages      Message[]
  reviews       Review[]   @relation("ReviewsReceived")
  reviewsGiven  Review[]   @relation("ReviewsGiven")
  viewHistory   ViewHistory[]
  reports       Report[]
  
  @@index([email])
  @@index([username])
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

model Ad {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  price       Decimal  @db.Decimal(10, 2)
  category    Category @relation(fields: [categoryId], references: [id])
  categoryId  String
  condition   Condition?
  dealType    DealType?
  location    String
  city        String?
  latitude    Float?
  longitude   Float?
  
  status      AdStatus @default(ACTIVE)
  isArchived  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  promoted    Boolean  @default(false)
  
  views       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime?
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  images      Image[]
  favorites   Favorite[]
  messages    Message[]
  reviews     Review[]
  viewHistory ViewHistory[]
  reports     Report[]
  
  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([price])
  @@index([title])
}

enum AdStatus {
  ACTIVE
  SOLD
  ARCHIVED
  PENDING_MODERATION
  REJECTED
}

enum DealType {
  SELL
  BUY
  EXCHANGE
  RENT
  FREE
}

enum Condition {
  NEW
  USED
  FOR_PARTS
  NEEDS_REPAIR
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  ads         Ad[]
  
  @@index([slug])
  @@index([parentId])
}

model Image {
  id        String   @id @default(cuid())
  url       String
  thumbnail String?
  order     Int      @default(0)
  
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  
  @@index([adId])
}

model Favorite {
  id        String   @id @default(cuid())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  
  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  isRead    Boolean  @default(false)
  
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId  String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  
  @@index([senderId])
  @@index([adId])
  @@index([createdAt])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String?  @db.Text
  
  reviewer  User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewee  User     @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)
  revieweeId String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  
  @@unique([reviewerId, adId])
  @@index([revieweeId])
  @@index([adId])
}

model ViewHistory {
  id        String   @id @default(cuid())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  
  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
}

model Report {
  id        String   @id @default(cuid())
  reason    String
  details   String?  @db.Text
  status    ReportStatus @default(PENDING)
  
  reporter  User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId String
  ad        Ad       @relation(fields: [adId], references: [id], onDelete: Cascade)
  adId      String
  
  createdAt DateTime @default(now())
  resolvedAt DateTime?
  
  @@index([reporterId])
  @@index([adId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// Rate limiting
model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // IP address or user ID
  count     Int      @default(1)
  resetAt   DateTime
  
  @@index([key])
  @@index([resetAt])
}